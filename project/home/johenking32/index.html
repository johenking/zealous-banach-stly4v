import React, { useState, useEffect, useMemo, useRef } from 'react';
import { 
  Plus, Trash2, GraduationCap, Loader2, CheckCircle2, 
  Layout, ListTodo, X, PieChart, Target, AlertCircle, Clock, LogOut, Settings, 
  BookOpen, ChevronRight, Star, Sparkles, Award, Boxes, LayoutDashboard, Flag,
  Menu, MoreHorizontal, Zap, Undo2, ChevronDown, Wifi, WifiOff
} from 'lucide-react';
import { initializeApp, getApps, getApp } from 'firebase/app';
import { 
  getAuth, 
  signInWithPopup, 
  signInAnonymously,
  signInWithCustomToken,
  GoogleAuthProvider, 
  signOut, 
  onAuthStateChanged 
} from 'firebase/auth';
import { 
  getFirestore, collection, doc, setDoc, deleteDoc, 
  onSnapshot, serverTimestamp, query, updateDoc,
  enableIndexedDbPersistence
} from 'firebase/firestore';

// =================================================================
// ğŸ”´ éƒ¨ç½²é…ç½® (ä¿æŒä¸å˜)
// =================================================================
const USER_FIREBASE_CONFIG = {
  apiKey: "AIzaSyAonGPelzYJXvgCwu7_X-M0hKnwNGydZRE",
  authDomain: "my-degree-planner.firebaseapp.com",
  projectId: "my-degree-planner",
  storageBucket: "my-degree-planner.firebasestorage.app",
  messagingSenderId: "61543774322",
  appId: "1:61543774322:web:5f41f4c7652cc140236aeb",
  measurementId: "G-SHGEBF4DMW"
};

// =================================================================
// ğŸš€ ç³»ç»Ÿåˆå§‹åŒ–
// =================================================================
let app, auth, db;
let configStatus = "pending";

try {
  if (typeof __firebase_config !== 'undefined' && __firebase_config) {
    if (!getApps().length) app = initializeApp(JSON.parse(__firebase_config));
    else app = getApp();
    configStatus = "canvas";
  } else if (USER_FIREBASE_CONFIG.apiKey !== "YOUR_API_KEY_HERE") {
    if (!getApps().length) app = initializeApp(USER_FIREBASE_CONFIG);
    else app = getApp();
    configStatus = "valid";
  } else {
    configStatus = "invalid";
  }

  if (configStatus === "valid" || configStatus === "canvas") {
    auth = getAuth(app);
    db = getFirestore(app);
    try {
        enableIndexedDbPersistence(db).catch(() => {});
    } catch (e) {}
  }
} catch (e) {
  console.error("Init Error:", e);
  configStatus = "invalid";
}

const googleProvider = new GoogleAuthProvider();

// =================================================================
// ğŸ“š æ•°æ®å¸¸é‡ (ä¿æŒä¸å˜)
// =================================================================
const CURRICULUM_DATA = {
  1: [
    { name: "ä¸­å›½è¿‘ç°ä»£å²çº²è¦", credits: 3, category: "é€šè¯†å¿…ä¿®" },
    { name: "è®¡ç®—æ€ç»´", credits: 3, category: "é€šè¯†å¿…ä¿®" },
    { name: "å¤§å­¦è‹±è¯­(1)", credits: 2, category: "é€šè¯†å¿…ä¿®" }, 
    { name: "ä½“è‚²(1)", credits: 1, category: "é€šè¯†å¿…ä¿®" },
    { name: "å†›äº‹ç†è®º", credits: 2, category: "é€šè¯†å¿…ä¿®" },
    { name: "å½¢åŠ¿ä¸æ”¿ç­–(1)", credits: 0, category: "é€šè¯†å¿…ä¿®" }, 
    { name: "é«˜ç­‰æ•°å­¦(1)", credits: 4, category: "å­¦ç§‘åŸºç¡€" },
    { name: "ç®¡ç†å­¦åŸç†", credits: 3, category: "å­¦ç§‘åŸºç¡€" },
    { name: "å›½å®¶å®‰å…¨æ•™è‚²", credits: 2, category: "é‡ç‚¹æå‡" },
    { name: "å¤§å­¦ç”Ÿå¿ƒç†å¥åº·æ•™è‚²", credits: 2, category: "é‡ç‚¹æå‡" },
    { name: "å†›äº‹æŠ€èƒ½", credits: 2, category: "é‡ç‚¹æå‡" },
    { name: "æ–°ç”Ÿç ”è®¨è¯¾", credits: 1, category: "ä¸“ä¸šå¿…ä¿®" }, 
  ],
  2: [
    { name: "æ€æƒ³é“å¾·ä¸æ³•æ²»", credits: 3, category: "é€šè¯†å¿…ä¿®" },
    { name: "ä½“è‚²(2)", credits: 1, category: "é€šè¯†å¿…ä¿®" },
    { name: "å½¢åŠ¿ä¸æ”¿ç­–(2)", credits: 0.5, category: "é€šè¯†å¿…ä¿®" }, 
    { name: "â€œå¤§æ€æ”¿â€ç¤¾ä¼šå®è·µ(1)", credits: 1, category: "é‡ç‚¹æå‡" },
    { name: "å››å²æ•™è‚²ç³»åˆ—ä¸“é¢˜", credits: 1, category: "é‡ç‚¹æå‡" },
    { name: "ç”Ÿæ¶¯å‘å±•:å­¦ä¸šèŒä¸šç›®æ ‡", credits: 1, category: "é‡ç‚¹æå‡" },
    { name: "é«˜ç­‰æ•°å­¦(2)", credits: 4, category: "å­¦ç§‘åŸºç¡€" },
    { name: "çº¿æ€§ä»£æ•°", credits: 4, category: "å­¦ç§‘åŸºç¡€" },
    { name: "ç»æµå­¦åŸç†", credits: 4, category: "å­¦ç§‘åŸºç¡€" },
    { name: "ä¼šè®¡å­¦åŸç†", credits: 3, category: "å­¦ç§‘åŸºç¡€" },
    { name: "å¤§å­¦è‹±è¯­(2)", credits: 2, category: "é€šè¯†å¿…ä¿®" },
  ],
  3: [
    { name: "é©¬å…‹æ€ä¸»ä¹‰åŸºæœ¬åŸç†", credits: 3, category: "é€šè¯†å¿…ä¿®" },
    { name: "ä½“è‚²(3)", credits: 1, category: "é€šè¯†å¿…ä¿®" },
    { name: "å½¢åŠ¿ä¸æ”¿ç­–(3)", credits: 0, category: "é€šè¯†å¿…ä¿®" },
    { name: "å¤§å­¦è‹±è¯­(3)", credits: 2, category: "é€šè¯†å¿…ä¿®" },
    { name: "ç¨‹åºè®¾è®¡", credits: 3, category: "å­¦ç§‘åŸºç¡€" },
    { name: "æ¦‚ç‡è®ºä¸æ•°ç†ç»Ÿè®¡", credits: 4, category: "å­¦ç§‘åŸºç¡€" },
    { name: "è¿ç­¹å­¦(1)", credits: 3, category: "å­¦ç§‘åŸºç¡€" },
    { name: "æ•°æ®åº“ç³»ç»ŸåŸç†ä¸åº”ç”¨", credits: 2, category: "å­¦ç§‘åŸºç¡€" },
    { name: "ç”µå­å•†åŠ¡", credits: 2.5, category: "ä¸“ä¸šå¿…ä¿®" },
    { name: "ä¾›åº”é“¾ç®¡ç†æ¦‚è®º", credits: 2, category: "ä¸“ä¸šå¿…ä¿®" },
  ],
  4: [
    { name: "ä½“è‚²(4)", credits: 1, category: "é€šè¯†å¿…ä¿®" },
    { name: "å½¢åŠ¿ä¸æ”¿ç­–(4)", credits: 0.5, category: "é€šè¯†å¿…ä¿®" },
    { name: "å¤§å­¦è‹±è¯­(4)", credits: 2, category: "é€šè¯†å¿…ä¿®" },
    { name: "â€œå¤§æ€æ”¿â€ç¤¾ä¼šå®è·µ(2)", credits: 0.5, category: "é‡ç‚¹æå‡" },
    { name: "ç³»ç»Ÿå·¥ç¨‹", credits: 3, category: "å­¦ç§‘åŸºç¡€" },
    { name: "ç»Ÿè®¡å­¦", credits: 2, category: "å­¦ç§‘åŸºç¡€" },
    { name: "è¿ç­¹å­¦(2)", credits: 2, category: "å­¦ç§‘åŸºç¡€" },
    { name: "è®¤çŸ¥å®ä¹ ", credits: 1, category: "ä¸“ä¸šå¿…ä¿®" },
    { name: "Pythonç¨‹åºè®¾è®¡", credits: 2, category: "ä¸“ä¸šå¿…ä¿®" },
    { name: "ç‰©æµç®¡ç†", credits: 2, category: "ä¸“ä¸šå¿…ä¿®" },
    { name: "è¿è¥ç®¡ç†(åŒè¯­)", credits: 2, category: "ä¸“ä¸šå¿…ä¿®" },
    { name: "è®¡é‡ç»æµå­¦", credits: 2, category: "ä¸“ä¸šå¿…ä¿®" },
    { name: "åº“å­˜ç®¡ç†ä¸æ§åˆ¶", credits: 2, category: "ä¸“ä¸šå¿…ä¿®" },
  ],
  5: [
    { name: "ä¹ è¿‘å¹³æ–°æ—¶ä»£ä¸­å›½ç‰¹è‰²...", credits: 3, category: "é€šè¯†å¿…ä¿®" },
    { name: "æ¯›æ³½ä¸œæ€æƒ³...", credits: 3, category: "é€šè¯†å¿…ä¿®" },
    { name: "å½¢åŠ¿ä¸æ”¿ç­–(5)", credits: 0, category: "é€šè¯†å¿…ä¿®" },
    { name: "ç®¡ç†ç ”ç©¶æ–¹æ³•", credits: 2, category: "å­¦ç§‘åŸºç¡€" },
    { name: "ç®¡ç†ä¿¡æ¯ç³»ç»Ÿ", credits: 3, category: "ä¸“ä¸šå¿…ä¿®" },
    { name: "ERPä¾›åº”é“¾ç»¼åˆå®éªŒ", credits: 1, category: "ä¸“ä¸šå¿…ä¿®" },
    { name: "ç®¡ç†å†³ç­–åˆ†æ", credits: 2, category: "ä¸“ä¸šå¿…ä¿®" },
    { name: "ç»„ç»‡ä¸æˆ˜ç•¥ç®¡ç†", credits: 2, category: "ä¸“ä¸šå¿…ä¿®" },
    { name: "ä¾›åº”é“¾é‡‘è", credits: 2, category: "ä¸“ä¸šå¿…ä¿®" },
    { name: "ä¾›åº”é“¾ç³»ç»Ÿè§„åˆ’ä¸è®¾è®¡", credits: 3, category: "ä¸“ä¸šå¿…ä¿®" },
    { name: "ä¾›åº”é“¾å»ºæ¨¡ä¸ä»¿çœŸ", credits: 3, category: "ä¸“ä¸šå¿…ä¿®" },
    { name: "ä¾›åº”é“¾èµ„æºè§„åˆ’", credits: 2, category: "ä¸“ä¸šå¿…ä¿®" },
  ],
  6: [
    { name: "å½¢åŠ¿ä¸æ”¿ç­–(6)", credits: 0.5, category: "é€šè¯†å¿…ä¿®" },
    { name: "â€œå¤§æ€æ”¿â€ç¤¾ä¼šå®è·µ(3)", credits: 0.5, category: "é‡ç‚¹æå‡" },
    { name: "ä¼ä¸šç»è¥æ¨¡æ‹Ÿ", credits: 1, category: "ä¸“ä¸šå¿…ä¿®" },
    { name: "å¤§æ•°æ®ç®¡ç†ä¸åˆ†æå®éªŒ", credits: 1, category: "ä¸“ä¸šå¿…ä¿®" },
    { name: "æ•°æ®ç§‘å­¦ä¸å¤§æ•°æ®åˆ†æ", credits: 2, category: "ä¸“ä¸šå¿…ä¿®" },
  ],
  7: [
    { name: "å½¢åŠ¿ä¸æ”¿ç­–(7)", credits: 0, category: "é€šè¯†å¿…ä¿®" },
    { name: "åŠ³åŠ¨æ•™è‚²", credits: 2, category: "é‡ç‚¹æå‡" },
    { name: "ï¼ˆå»ºè®®ï¼‰ä¸“ä¸šé€‰ä¿®è¯¾", credits: 0, category: "ä¸“ä¸šé€‰ä¿®", isPlaceholder: true },
  ],
  8: [
    { name: "å½¢åŠ¿ä¸æ”¿ç­–(8)", credits: 0.5, category: "é€šè¯†å¿…ä¿®" },
    { name: "æ¯•ä¸šå®ä¹ ", credits: 4, category: "ä¸“ä¸šå¿…ä¿®" },
    { name: "æ¯•ä¸šè®ºæ–‡(è®¾è®¡)", credits: 6, category: "ä¸“ä¸šå¿…ä¿®" },
  ]
};

const GE_CORE_MODULES = {
  "é€šæ ¸-äººæ–‡ç´ å…»": { required: 2, color: "bg-pink-500", shadow: "shadow-pink-200" },
  "é€šæ ¸-è‰ºæœ¯å®¡ç¾": { required: 2, color: "bg-rose-500", shadow: "shadow-rose-200" },
  "é€šæ ¸-ç§‘æŠ€ç´ å…»": { required: 2, color: "bg-fuchsia-500", shadow: "shadow-fuchsia-200" },
  "é€šæ ¸-ç”Ÿå‘½å¥åº·": { required: 2, color: "bg-purple-500", shadow: "shadow-purple-200" },
};

const EXTENSION_MODULES = {
  "æ‹“å±•-å­¦æœ¯åˆ›æ–°": { required: 1, color: "bg-amber-500", shadow: "shadow-amber-200" },
  "æ‹“å±•-æ–‡åŒ–è‰ºæœ¯": { required: 1, color: "bg-orange-500", shadow: "shadow-orange-200" },
  "æ‹“å±•-ç¤¾ä¼šæœåŠ¡": { required: 1, color: "bg-yellow-600", shadow: "shadow-yellow-200" },
  "æ‹“å±•-èº«å¿ƒå¥åº·": { required: 1, color: "bg-yellow-500", shadow: "shadow-yellow-200" },
};

const INNOVATION_MODULES = {
  "åˆ›æ–°-ç¨·ä¸‹åˆ›æ–°": { required: 2, color: "bg-cyan-500", shadow: "shadow-cyan-200" },
  "åˆ›ä¸š-é½é²åˆ›ä¸š": { required: 2, color: "bg-sky-500", shadow: "shadow-sky-200" },
};

const BASE_REQUIREMENTS = {
  "é€šè¯†å¿…ä¿®": { required: 34, color: "bg-blue-600" },
  "å­¦ç§‘åŸºç¡€": { required: 43, color: "bg-indigo-600" },
  "ä¸“ä¸šå¿…ä¿®": { required: 48.5, color: "bg-violet-600" },
  "ä¸“ä¸šé€‰ä¿®": { required: 10, color: "bg-slate-700" },
  "é‡ç‚¹æå‡": { required: 12, color: "bg-emerald-600" },
  "é€šè¯†é€‰ä¿®": { required: 4, color: "bg-gray-500" },
};

const ALL_STATS_CONFIG = {
  ...BASE_REQUIREMENTS,
  ...GE_CORE_MODULES,
  ...EXTENSION_MODULES,
  ...INNOVATION_MODULES
};

const PRESET_ELECTIVES = [
  "æ•°æ®ç»“æ„", "å·¥ç¨‹ç»æµå­¦", "ä¾›åº”é“¾æˆæœ¬ä¸ç»©æ•ˆç®¡ç†", "å®¢æˆ·å…³ç³»ç®¡ç†",
  "å¯æŒç»­ä¾›åº”é“¾ç®¡ç†", "å›½é™…ç‰©æµä¸ä¾›åº”é“¾ç®¡ç†", "ä¾›åº”é“¾ç®¡ç†å‰æ²¿(åŒè¯­)", 
  "ç½‘ç»œè¥é”€(åŒè¯­)", "è´¢åŠ¡ç®¡ç†å­¦", "é¡¹ç›®ç®¡ç†", "æœåŠ¡ç®¡ç†", 
  "äº‘è®¡ç®—ä¸ç‰©è”ç½‘", "è´¨é‡ç®¡ç†ä¸å¯é æ€§å·¥ç¨‹", "äº§å“æŠ€æœ¯ç®¡ç†", "å¸‚åœºè¥é”€å­¦"
];

const DROPDOWN_GROUPS = [
  { group: "æ ¸å¿ƒè¯¾ç¨‹", options: [
      { label: "ä¸“ä¸šé€‰ä¿®è¯¾ (é€šç”¨)", value: "ä¸“ä¸šé€‰ä¿®", parent: "ä¸“ä¸šé€‰ä¿®" },
      ...PRESET_ELECTIVES.map(c => ({ label: `[ä¸“é€‰] ${c}`, value: "ä¸“ä¸šé€‰ä¿®", presetName: c })),
      { label: "é€šè¯†é€‰ä¿®è¯¾", value: "é€šè¯†é€‰ä¿®", parent: "é€šè¯†é€‰ä¿®" },
      { label: "é‡ç‚¹æå‡è®¡åˆ’", value: "é‡ç‚¹æå‡", parent: "é‡ç‚¹æå‡" },
  ]},
  { group: "é€šè¯†æ ¸å¿ƒ (å„æ¨¡å—ä¿®2å­¦åˆ†)", options: Object.keys(GE_CORE_MODULES).map(k => ({ label: k, value: k })) },
  { group: "æ‹“å±•åŸ¹å…» (å„æ¨¡å—ä¿®1å­¦åˆ†)", options: Object.keys(EXTENSION_MODULES).map(k => ({ label: k, value: k })) },
  { group: "åˆ›æ–°åˆ›ä¸š (å…±4å­¦åˆ†)", options: Object.keys(INNOVATION_MODULES).map(k => ({ label: k, value: k })) }
];

// =================================================================
// ğŸ¨ ç»„ä»¶ï¼šéª¨æ¶å± (Shimmer Effect)
// =================================================================
const SkeletonCard = () => (
  <div className="bg-white rounded-2xl p-5 border border-slate-100 relative overflow-hidden h-32">
    <div className="animate-shimmer absolute inset-0 bg-gradient-to-r from-transparent via-slate-100/50 to-transparent -translate-x-full" style={{zIndex:1}}></div>
    <div className="h-4 w-1/3 bg-slate-100 rounded mb-4"></div>
    <div className="h-2 w-full bg-slate-100 rounded mb-2"></div>
    <div className="h-2 w-2/3 bg-slate-100 rounded"></div>
  </div>
);

// =================================================================
// ğŸ¨ ä¸»åº”ç”¨
// =================================================================
export default function App() {
  const [user, setUser] = useState(null);
  const [authLoading, setAuthLoading] = useState(true);
  const [loading, setLoading] = useState(true);
  const [activeTab, setActiveTab] = useState('plan'); 
  const [planProgress, setPlanProgress] = useState({}); 
  const [electives, setElectives] = useState([]); 
  const [selectedSemester, setSelectedSemester] = useState(null);
  const [electiveForm, setElectiveForm] = useState({ name: '', credits: '', category: 'ä¸“ä¸šé€‰ä¿®' });
  const [loginError, setLoginError] = useState(null);
  const [isOnline, setIsOnline] = useState(navigator.onLine);
  
  const topRef = useRef(null);

  // -----------------------------------------------------------------
  // âš¡ æ ¸å¿ƒä¼˜åŒ–ï¼šå…¨å±€æ ·å¼æ³¨å…¥ (è§£å†³ç•Œé¢ä¸ä¸€è‡´å’ŒiOSæ‰‹æ„Ÿ)
  // -----------------------------------------------------------------
  useEffect(() => {
    const handleStatusChange = () => setIsOnline(navigator.onLine);
    window.addEventListener('online', handleStatusChange);
    window.addEventListener('offline', handleStatusChange);

    const style = document.createElement('style');
    style.innerHTML = `
      /* 1. å¼ºåˆ¶ç»Ÿä¸€èƒŒæ™¯è‰²ï¼Œè§£å†³"è“åº•ç™½å¤´"é—®é¢˜ */
      html, body, #root {
        background-color: #f8fafc !important; /* ç»Ÿä¸€æµ…ç°èƒŒæ™¯ */
        margin: 0;
        padding: 0;
        height: 100%;
        width: 100%;
        overscroll-behavior-y: none; /* ç¦æ­¢æµè§ˆå™¨é»˜è®¤çš„æ©¡çš®ç­‹å›å¼¹ï¼Œç”±Appå†…éƒ¨å®¹å™¨æ¥ç®¡ */
      }

      /* 2. iOS ä¸“å±ä¼˜åŒ– */
      body {
        -webkit-tap-highlight-color: transparent; /* å»é™¤ç‚¹å‡»é«˜äº®å— */
        -webkit-touch-callout: none; /* ç¦ç”¨é•¿æŒ‰èœå• */
        -webkit-font-smoothing: antialiased; /* å­—ä½“æŠ—é”¯é½¿ */
        user-select: none; /* ç¦æ­¢é•¿æŒ‰é€‰ä¸­æ–‡æœ¬ï¼Œæ›´æœ‰Appæ„Ÿ */
      }

      /* 3. ä¼˜åŒ–æ»šåŠ¨å®¹å™¨æ‰‹æ„Ÿ */
      .scroll-container {
        -webkit-overflow-scrolling: touch; /* å¼€å¯iOSç¡¬ä»¶åŠ é€Ÿæ»šåŠ¨ */
      }

      /* 4. åŠ¨ç”»å®šä¹‰ */
      @keyframes shimmer {
        100% { transform: translateX(100%); }
      }
      .animate-shimmer { animation: shimmer 1.5s infinite; }
      
      .tap-active { transition: transform 0.1s; }
      .tap-active:active { transform: scale(0.96); }
      
      .modal-enter { animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
      @keyframes slideUp {
        from { transform: translateY(100%); opacity: 0; }
        to { transform: translateY(0); opacity: 1; }
      }

      /* éšè—æ»šåŠ¨æ¡ */
      .no-scrollbar::-webkit-scrollbar { display: none; }
      .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    `;
    document.head.appendChild(style);
    
    // è®¾ç½® viewport ä»¥é€‚é…åˆ˜æµ·å±
    let meta = document.querySelector('meta[name="viewport"]');
    if (!meta) {
        meta = document.createElement('meta');
        meta.name = "viewport";
        document.head.appendChild(meta);
    }
    meta.content = "width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover";

    return () => {
        document.head.removeChild(style);
        window.removeEventListener('online', handleStatusChange);
        window.removeEventListener('offline', handleStatusChange);
    };
  }, []);

  // --- Auth & Initial Sync ---
  useEffect(() => {
    if (configStatus === "invalid") {
      setAuthLoading(false);
      setLoading(false);
      return;
    }

    const initAuth = async () => {
        if (configStatus === 'canvas') {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (err) {
                console.error("Canvas Auth Error", err);
            }
        }
    };
    initAuth();

    const unsubscribe = onAuthStateChanged(auth, (u) => {
      setUser(u);
      setAuthLoading(false);
      if (!u) {
        setLoading(false);
        setPlanProgress({});
        setElectives([]);
      }
    });
    return () => unsubscribe();
  }, []);

  const handleGoogleLogin = async () => {
    setLoginError(null);
    try {
      if (configStatus === 'canvas') {
        alert("Canvas ç¯å¢ƒå·²è‡ªåŠ¨ç™»å½•ã€‚");
        return;
      }
      await signInWithPopup(auth, googleProvider);
    } catch (error) {
      setLoginError(`ç™»å½•å¤±è´¥: ${error.message}`);
    }
  };

  const handleGuestLogin = () => {
    setUser({ uid: "guest_user", displayName: "è®¿å®¢æ¨¡å¼", isAnonymous: true });
    setAuthLoading(false);
  };

  // --- Local Cache Helpers ---
  const loadFromCache = (uid, key) => {
      try {
          const cached = localStorage.getItem(`cache_v3_${uid}_${key}`);
          return cached ? JSON.parse(cached) : null;
      } catch (e) { console.warn("Cache read error", e); return null; }
  };
  
  const saveToCache = (uid, key, data) => {
      try {
          if (data && Object.keys(data).length > 0) {
              localStorage.setItem(`cache_v3_${uid}_${key}`, JSON.stringify(data));
          }
      } catch (e) { console.warn("Cache write error", e); }
  };

  // --- Data Sync ---
  useEffect(() => {
    if (!user || configStatus === "invalid") return;
    setLoading(true);

    const appId = configStatus === 'canvas' ? (typeof __app_id !== 'undefined' ? __app_id : 'default') : 'deployed';
    
    // ä¼˜å…ˆè¯»å–ç¼“å­˜
    const cachedPlan = loadFromCache(user.uid, 'planProgress');
    const cachedElec = loadFromCache(user.uid, 'electives');
    
    if (cachedPlan) setPlanProgress(cachedPlan);
    if (cachedElec) setElectives(cachedElec);
    if (cachedPlan || cachedElec) setLoading(false);

    // è”ç½‘æ›´æ–°
    const planRef = configStatus === 'canvas' 
        ? doc(db, 'artifacts', appId, 'users', user.uid, 'data', 'plan_progress_v3')
        : doc(db, 'users', user.uid, 'data', 'plan_progress_v3');
        
    const electivesRef = configStatus === 'canvas' 
        ? collection(db, 'artifacts', appId, 'users', user.uid, 'electives_v3')
        : collection(db, 'users', user.uid, 'electives_v3');

    const unsubPlan = onSnapshot(planRef, (docSnap) => {
      const data = docSnap.exists() ? docSnap.data() : {};
      setPlanProgress(data);
      saveToCache(user.uid, 'planProgress', data);
      setLoading(false);
    }, (err) => {
        console.warn("Firestore error:", err);
        setLoading(false); 
    });

    const unsubElec = onSnapshot(query(electivesRef), (snap) => {
      const data = snap.docs.map(d => ({ id: d.id, ...d.data() }));
      setElectives(data);
      saveToCache(user.uid, 'electives', data);
      setLoading(false);
    }, (err) => {
        console.warn("Firestore error:", err);
        setLoading(false); 
    });

    return () => { unsubPlan(); unsubElec(); };
  }, [user]);

  // --- Handlers ---
  const getDBPath = () => {
      const isCanvas = configStatus === 'canvas';
      const appId = typeof __app_id !== 'undefined' ? __app_id : 'default';
      return {
          planDoc: isCanvas 
            ? doc(db, 'artifacts', appId, 'users', user.uid, 'data', 'plan_progress_v3')
            : doc(db, 'users', user.uid, 'data', 'plan_progress_v3'),
          elecCol: isCanvas 
            ? collection(db, 'artifacts', appId, 'users', user.uid, 'electives_v3')
            : collection(db, 'users', user.uid, 'electives_v3'),
          elecDoc: (id) => isCanvas
            ? doc(db, 'artifacts', appId, 'users', user.uid, 'electives_v3', id)
            : doc(db, 'users', user.uid, 'electives_v3', id)
      };
  }

  const handleToggleFixedCourse = async (courseName) => {
    if (!user) return;
    const { planDoc } = getDBPath();
    const current = planProgress[courseName] || {};
    const newData = { ...planProgress };
    
    if (!current.taken) {
        newData[courseName] = { taken: true, status: 'planned', score: '' };
    } else if (current.status === 'planned') {
        delete newData[courseName];
    } else if (current.status === 'completed') {
        if(confirm(`ç¡®å®šè¦æ’¤é”€â€œ${courseName}â€çš„å·²ä¿®çŠ¶æ€å—ï¼Ÿ`)) {
             delete newData[courseName];
        } else {
            return;
        }
    }
    
    setPlanProgress(newData); 
    saveToCache(user.uid, 'planProgress', newData); 
    
    try { await setDoc(planDoc, newData); } catch(e) {}
  };

  const handleUpdateFixedScore = async (courseName, score) => {
    if (!user) return;
    const { planDoc } = getDBPath();
    const newData = {
      ...planProgress,
      [courseName]: { ...planProgress[courseName], score, status: score ? 'completed' : 'planned' }
    };
    setPlanProgress(newData);
    saveToCache(user.uid, 'planProgress', newData);
    await setDoc(planDoc, newData);
  };

  const handleAddElective = async (status) => {
    if (!user || !electiveForm.name || !electiveForm.credits) return;
    const { elecCol } = getDBPath();
    await setDoc(doc(elecCol), {
      name: electiveForm.name,
      credits: parseFloat(electiveForm.credits),
      category: electiveForm.category,
      subCategory: electiveForm.category, 
      status: status, 
      passed: status === 'completed',
      createdAt: serverTimestamp()
    });
    setElectiveForm({ ...electiveForm, name: '', credits: '' });
  };

  const handleDeleteElective = async (id) => {
    if(confirm("ç¡®å®šåˆ é™¤è®°å½•ï¼Ÿ")) {
        const { elecDoc } = getDBPath();
        await deleteDoc(elecDoc(id));
    }
  };

  const handleToggleElectiveStatus = async (item) => {
      const { elecDoc } = getDBPath();
      const newStatus = item.status === 'planned' ? 'completed' : 'planned';
      await updateDoc(elecDoc(item.id), { status: newStatus });
  };

  const handlePresetSelect = (e) => {
      const selectedIndex = e.target.selectedIndex;
      const option = e.target.options[selectedIndex];
      if (option.text.startsWith('[ä¸“é€‰]')) {
          setElectiveForm({
              ...electiveForm,
              category: e.target.value,
              name: option.text.replace('[ä¸“é€‰] ', '')
          });
      } else {
          setElectiveForm({...electiveForm, category: e.target.value});
      }
  };

  // --- Statistics Logic ---
  const stats = useMemo(() => {
    const breakdown = {};
    Object.keys(ALL_STATS_CONFIG).forEach(key => {
      breakdown[key] = { earned: 0, planned: 0, required: ALL_STATS_CONFIG[key].required };
    });

    let totalEarned = 0, totalPlanned = 0, totalScore = 0, gpaCredits = 0;

    Object.keys(CURRICULUM_DATA).forEach(sem => {
      CURRICULUM_DATA[sem].forEach(course => {
        if (course.isPlaceholder) return;
        const record = planProgress[course.name];
        if (record && record.taken) {
          const cat = course.category;
          if (breakdown[cat]) {
            if (record.status === 'completed') {
                breakdown[cat].earned += course.credits;
                totalEarned += course.credits;
                const s = parseFloat(record.score);
                if (!isNaN(s)) { totalScore += s * course.credits; gpaCredits += course.credits; }
            } else {
                breakdown[cat].planned += course.credits;
                totalPlanned += course.credits;
            }
          }
        }
      });
    });

    electives.forEach(el => {
      const catKey = el.category || el.subCategory; 
      if (breakdown[catKey]) {
        if (el.status === 'completed') {
            breakdown[catKey].earned += el.credits;
            totalEarned += el.credits;
        } else {
            breakdown[catKey].planned += el.credits;
            totalPlanned += el.credits;
        }
      }
    });

    const gpa = gpaCredits > 0 ? (totalScore / gpaCredits).toFixed(2) : "0.00";
    return { breakdown, totalEarned, totalPlanned, gpa, totalRequired: 167.5 };
  }, [planProgress, electives]);

  // --- UI Components ---
  if (authLoading) return (
      <div className="h-screen flex flex-col items-center justify-center bg-slate-50 overscroll-none">
          <div className="relative w-20 h-20 mb-6">
            <div className="absolute inset-0 bg-indigo-200 rounded-full animate-ping opacity-20"></div>
            <div className="relative bg-indigo-600 w-20 h-20 rounded-2xl flex items-center justify-center shadow-lg shadow-indigo-200">
              <GraduationCap className="w-10 h-10 text-white" />
            </div>
          </div>
          <span className="text-slate-400 text-sm font-medium tracking-wide animate-pulse">èµ„æºåŠ è½½ä¸­...</span>
      </div>
  );

  if (configStatus === "invalid") {
      return (
        <div className="h-screen flex items-center justify-center bg-slate-50 font-sans p-6 overscroll-none">
            <div className="bg-white p-10 rounded-3xl shadow-xl max-w-lg w-full text-center">
                <Settings className="w-10 h-10 text-red-500 mx-auto mb-4" />
                <h1 className="text-xl font-bold text-slate-800 mb-2">é…ç½®æœªå®Œæˆ</h1>
                <p className="text-slate-500">è¯·åœ¨ä»£ç ä¸­å¡«å…¥ Firebase API Keyã€‚</p>
            </div>
        </div>
      );
  }

  if (!user) {
    return (
      <div className="h-screen flex flex-col items-center justify-center bg-gradient-to-br from-slate-50 to-indigo-50/50 p-6 font-sans overscroll-none">
        <div className="bg-white/80 backdrop-blur-xl p-8 md:p-12 rounded-[2.5rem] shadow-xl shadow-indigo-100 max-w-md w-full text-center border border-white">
          <div className="bg-indigo-600 w-20 h-20 rounded-3xl flex items-center justify-center mx-auto mb-6 shadow-lg shadow-indigo-300 transform rotate-3">
            <GraduationCap className="text-white w-10 h-10" />
          </div>
          <h1 className="text-2xl md:text-3xl font-black text-slate-800 mb-2 tracking-tight">å­¦ä¸šè§„åˆ’ç³»ç»Ÿ</h1>
          <p className="text-slate-500 mb-10 font-medium text-sm">å…¨å‘¨æœŸå­¦åˆ†è¿½è¸ª Â· ç§»åŠ¨ç«¯ä¼˜åŒ–ç‰ˆ</p>
          
          {loginError && (
              <div className="mb-6 bg-red-50 text-red-600 p-4 rounded-2xl text-xs font-bold flex items-center text-left border border-red-100">
                  <AlertCircle className="w-4 h-4 mr-2 flex-shrink-0" />
                  {loginError}
              </div>
          )}

          <button onClick={handleGoogleLogin} className="w-full bg-slate-900 text-white py-4 px-6 rounded-2xl font-bold text-base hover:bg-slate-800 transition-all flex items-center justify-center shadow-xl mb-4 tap-active">
            ä½¿ç”¨ Google è´¦å·ç™»å½•
          </button>
          <button onClick={handleGuestLogin} className="w-full bg-slate-100 text-slate-600 py-4 rounded-2xl font-bold text-sm hover:bg-slate-200 transition-all flex items-center justify-center tap-active">
            æˆ‘æ˜¯è®¿å®¢ (ç›´æ¥è¯•ç”¨)
          </button>
        </div>
      </div>
    );
  }

  const tabIndex = ['plan', 'electives', 'stats'].indexOf(activeTab);
  const tabWidth = 100 / 3;

  return (
    // å¢åŠ  min-h-screen ç¡®ä¿é“ºæ»¡ï¼Œoverscroll-y-none äº¤ç»™å†…éƒ¨å®¹å™¨
    <div className="min-h-screen bg-[#f8fafc] text-slate-800 font-sans pb-24 md:pb-10 selection:bg-indigo-100 flex flex-col" ref={topRef}>
      
      {/* é¡¶éƒ¨å¯¼èˆª (Glassmorphism & Sticky) */}
      <div className="bg-white/80 backdrop-blur-xl border-b border-slate-200/60 sticky top-0 z-30 transition-all duration-300">
        <div className="max-w-6xl mx-auto px-4 md:px-6 h-14 md:h-16 flex items-center justify-between">
          <div className="flex items-center space-x-3" onClick={() => window.scrollTo({top: 0, behavior: 'smooth'})}>
            <div className="bg-indigo-600 p-1.5 rounded-lg shadow-sm shadow-indigo-200"><GraduationCap className="w-4 h-4 md:w-5 md:h-5 text-white" /></div>
            <span className="font-bold text-slate-800 text-base md:text-lg tracking-tight">å­¦ä¸šè§„åˆ’</span>
          </div>
          
          <div className="flex items-center gap-3">
              {!isOnline && (
                  <div className="flex items-center text-amber-600 bg-amber-50 px-2 py-1 rounded-md border border-amber-100 animate-pulse">
                      <WifiOff className="w-3 h-3 md:w-4 md:h-4 mr-1.5"/>
                      <span className="text-[10px] md:text-xs font-bold">ç¦»çº¿æ¨¡å¼</span>
                  </div>
              )}
              {isOnline && (
                   <div className="hidden md:flex items-center text-green-600 bg-green-50 px-2 py-1 rounded-md border border-green-100">
                      <Wifi className="w-3 h-3 md:w-4 md:h-4 mr-1.5"/>
                      <span className="text-[10px] md:text-xs font-bold">å·²è¿æ¥</span>
                  </div>
              )}

              <span className="hidden md:inline text-xs font-mono text-slate-400 bg-slate-100 px-2 py-1 rounded-md">{user.displayName || 'User'}</span>
              <button onClick={() => signOut(auth)} className="p-2 hover:bg-red-50 hover:text-red-500 rounded-full transition-colors tap-active"><LogOut className="w-5 h-5"/></button>
          </div>
        </div>
      </div>

      <main className="flex-1 max-w-6xl mx-auto px-4 md:px-6 mt-4 md:mt-8 space-y-6 w-full scroll-container">
        
        {/* Mobile Segment Control (iOS style) */}
        <div className="md:hidden sticky top-16 z-20 bg-[#f8fafc] pt-2 pb-2">
           <div className="bg-slate-200/60 p-1 rounded-xl relative flex h-11 backdrop-blur-sm">
             <div 
               className="absolute top-1 bottom-1 bg-white rounded-lg shadow-sm transition-all duration-300 ease-[cubic-bezier(0.16,1,0.3,1)]"
               style={{ left: `${tabIndex * tabWidth + 1}%`, width: `${tabWidth - 2}%` }}
             ></div>
             {['plan', 'electives', 'stats'].map(tab => (
               <button 
                 key={tab}
                 onClick={() => { setActiveTab(tab); window.scrollTo({top:0, behavior:'smooth'}); }} 
                 className={`flex-1 relative z-10 text-xs font-bold transition-colors duration-200 ${activeTab === tab ? 'text-indigo-600' : 'text-slate-500'}`}
               >
                 {{plan: 'å¿…ä¿®è¯¾è¡¨', electives: 'å½•å…¥é€‰ä¿®', stats: 'å­¦åˆ†ç»Ÿè®¡'}[tab]}
               </button>
             ))}
           </div>
        </div>

        {/* Desktop Tabs */}
        <div className="hidden md:flex bg-white p-1.5 rounded-2xl shadow-sm inline-flex mb-6 border border-slate-100">
             {['plan', 'electives', 'stats'].map(tab => (
               <button 
                 key={tab}
                 onClick={() => setActiveTab(tab)} 
                 className={`
                   px-6 py-2.5 rounded-xl text-sm font-bold transition-all flex items-center tap-active
                   ${activeTab === tab ? 'bg-indigo-50 text-indigo-600 shadow-none' : 'text-slate-500 hover:text-slate-700 hover:bg-slate-50'}
                 `}
               >
                 {tab === 'plan' && <Layout className="w-4 h-4 mr-2" />}
                 {tab === 'electives' && <ListTodo className="w-4 h-4 mr-2" />}
                 {tab === 'stats' && <PieChart className="w-4 h-4 mr-2" />}
                 {{plan: 'æˆ‘çš„è¯¾è¡¨', electives: 'è¯¾ç¨‹å½•å…¥', stats: 'å­¦åˆ†ç»Ÿè®¡'}[tab]}
               </button>
             ))}
        </div>

        {/* 1. å¿…ä¿®è¯¾è¡¨è§†å›¾ */}
        {activeTab === 'plan' && (
          <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 animate-in fade-in zoom-in-95 duration-300">
            {loading && [1,2,3,4,5,6,7,8].map(i => <SkeletonCard key={i} />)}
            
            {!loading && [1, 2, 3, 4, 5, 6, 7, 8].map(sem => {
              const semCourses = CURRICULUM_DATA[sem];
              const completed = semCourses.filter(c => !c.isPlaceholder && planProgress[c.name]?.status === 'completed').length;
              const planned = semCourses.filter(c => !c.isPlaceholder && planProgress[c.name]?.status === 'planned').length;
              const realCourses = semCourses.filter(c => !c.isPlaceholder);
              const progress = Math.round((completed / realCourses.length) * 100);
              const planWidth = Math.round(((completed + planned) / realCourses.length) * 100);

              return (
                <div 
                  key={sem} 
                  onClick={() => setSelectedSemester(sem)} 
                  className={`
                    cursor-pointer bg-white rounded-2xl border p-5 relative overflow-hidden group tap-active
                    ${selectedSemester === sem ? 'ring-2 ring-indigo-500 border-indigo-500' : 'border-slate-100 shadow-sm shadow-slate-200/50'}
                  `}
                >
                  <div className="flex justify-between items-center mb-4">
                    <div className="flex items-center gap-2">
                        <span className="text-sm font-black text-slate-700">ç¬¬ {sem} å­¦æœŸ</span>
                        {progress === 100 && <CheckCircle2 className="w-4 h-4 text-green-500" />}
                    </div>
                    <div className="flex items-center space-x-1 text-xs font-bold bg-slate-50 px-2 py-1 rounded-lg">
                        <span className="text-indigo-600">{completed}</span>
                        {planned > 0 && <span className="text-amber-500">+{planned}</span>}
                        <span className="text-slate-300">/ {realCourses.length}</span>
                    </div>
                  </div>
                  
                  <div className="w-full bg-slate-100 h-2 rounded-full mb-5 overflow-hidden relative">
                    <div className="absolute left-0 top-0 h-full bg-[url('https://www.transparenttextures.com/patterns/diagonal-stripes.png')] opacity-30 w-full z-10"></div>
                    <div className="absolute left-0 top-0 bg-amber-300 h-full transition-all duration-1000 ease-out" style={{width: `${planWidth}%`}}></div>
                    <div className="absolute left-0 top-0 bg-indigo-500 h-full transition-all duration-1000 ease-out shadow-[0_0_10px_rgba(99,102,241,0.5)]" style={{width: `${progress}%`}}></div>
                  </div>

                  <div className="space-y-2.5">
                    {semCourses.slice(0, 3).map(c => !c.isPlaceholder && (
                      <div key={c.name} className="flex items-center text-xs text-slate-600">
                        <div className={`w-2 h-2 rounded-full mr-2.5 flex-shrink-0 transition-colors duration-300 ${planProgress[c.name]?.status === 'completed' ? 'bg-green-400' : planProgress[c.name]?.status === 'planned' ? 'bg-amber-400' : 'bg-slate-200'}`}></div>
                        <span className={`truncate transition-all duration-300 ${planProgress[c.name]?.status === 'completed' && 'opacity-40 line-through'}`}>{c.name}</span>
                      </div>
                    ))}
                    {semCourses.length > 3 && <div className="text-[10px] text-slate-400 pl-4 font-medium">... è¿˜æœ‰ {semCourses.length - 3} é—¨</div>}
                  </div>
                  
                  <div className="absolute bottom-4 right-4 text-slate-200 group-hover:text-indigo-600 transition-colors">
                      <ChevronRight className="w-5 h-5"/>
                  </div>
                </div>
              );
            })}
          </div>
        )}

        {/* 2. å½•å…¥ç•Œé¢ */}
        {activeTab === 'electives' && (
          <div className="grid grid-cols-1 md:grid-cols-3 gap-6 md:gap-8 animate-in fade-in slide-in-from-bottom-2 duration-300">
            <div className="md:col-span-1">
              <div className="bg-white p-6 rounded-3xl border border-slate-100 shadow-xl shadow-slate-200/50 sticky top-24">
                <h3 className="font-bold text-lg mb-6 flex items-center text-slate-800"><Plus className="w-5 h-5 mr-2 text-indigo-600" /> å½•å…¥è¯¾ç¨‹</h3>
                <div className="space-y-5">
                  <div>
                    <label className="block text-[10px] font-black text-slate-400 uppercase mb-2 tracking-wider">ç²¾ç»†æ¨¡å—åˆ†ç±»</label>
                    <div className="relative">
                      <select className="w-full bg-slate-50 border-none rounded-xl px-4 py-3.5 text-sm font-bold focus:ring-2 focus:ring-indigo-500 appearance-none text-slate-700" value={electiveForm.category} onChange={handlePresetSelect}>
                        {DROPDOWN_GROUPS.map(g => (
                          <optgroup key={g.group} label={g.group}>{g.options.map(o => <option key={o.label} value={o.value}>{o.label}</option>)}</optgroup>
                        ))}
                      </select>
                      <ChevronDown className="w-4 h-4 text-slate-400 absolute right-4 top-4 pointer-events-none" />
                    </div>
                  </div>
                  <div>
                    <label className="block text-[10px] font-black text-slate-400 uppercase mb-2 tracking-wider">è¯¾ç¨‹åç§°</label>
                    <input className="w-full bg-slate-50 border-none rounded-xl px-4 py-3.5 text-sm focus:ring-2 focus:ring-indigo-500 text-slate-700 font-medium" placeholder="ä¾‹å¦‚ï¼šæ’ç”»è®¾è®¡" value={electiveForm.name} onChange={e => setElectiveForm({...electiveForm, name: e.target.value})} />
                  </div>
                  <div>
                    <label className="block text-[10px] font-black text-slate-400 uppercase mb-2 tracking-wider">å­¦åˆ†</label>
                    <input type="number" className="w-full bg-slate-50 border-none rounded-xl px-4 py-3.5 text-sm focus:ring-2 focus:ring-indigo-500 text-slate-700 font-medium" placeholder="2.0" value={electiveForm.credits} onChange={e => setElectiveForm({...electiveForm, credits: e.target.value})} />
                  </div>
                  <div className="grid grid-cols-2 gap-3 pt-2">
                    <button onClick={() => handleAddElective('planned')} className="bg-amber-50 text-amber-700 hover:bg-amber-100 py-3.5 rounded-xl text-sm font-bold transition-all tap-active flex items-center justify-center"><Clock className="w-4 h-4 mr-1.5"/> è®¡åˆ’</button>
                    <button onClick={() => handleAddElective('completed')} className="bg-indigo-600 text-white hover:bg-indigo-700 py-3.5 rounded-xl text-sm font-bold transition-all shadow-lg shadow-indigo-200 tap-active flex items-center justify-center"><CheckCircle2 className="w-4 h-4 mr-1.5"/> å·²ä¿®</button>
                  </div>
                </div>
              </div>
            </div>
            
            <div className="md:col-span-2 space-y-3 pb-20">
               {electives.length === 0 ? (
                 <div className="text-center py-20 bg-white rounded-3xl border border-slate-100 shadow-sm">
                   <div className="bg-slate-50 w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-4 animate-bounce"><BookOpen className="w-8 h-8 text-slate-300" /></div>
                   <p className="text-slate-400 text-sm font-medium">è¿˜æ²¡æœ‰å½•å…¥ä»»ä½•é€‰ä¿®/æ‹“å±•è¯¾ç¨‹</p>
                   <p className="text-slate-300 text-xs mt-2">ç‚¹å‡»å·¦ä¾§/ä¸Šæ–¹è¡¨å•æ·»åŠ </p>
                 </div>
               ) : electives.map(item => (
                 <div key={item.id} className="bg-white p-4 rounded-2xl border border-slate-100 shadow-sm flex justify-between items-center group tap-active animate-in slide-in-from-bottom-2 duration-300">
                   <div className="flex items-center gap-4">
                       <div className={`w-12 h-12 rounded-2xl flex items-center justify-center transition-colors duration-300 ${item.status === 'completed' ? 'bg-green-50 text-green-600' : 'bg-amber-50 text-amber-600'}`}>
                           {item.status === 'completed' ? <CheckCircle2 className="w-6 h-6" /> : <Clock className="w-6 h-6" />}
                       </div>
                       <div>
                         <div className="flex items-center gap-2 mb-1">
                            <span className={`text-[10px] font-bold px-2 py-0.5 rounded text-white shadow-sm ${ALL_STATS_CONFIG[item.category]?.color || 'bg-slate-400'}`}>{item.category}</span>
                            <span className="text-xs font-bold text-slate-400">{item.credits} å­¦åˆ†</span>
                         </div>
                         <h4 className="font-bold text-slate-700 text-base">{item.name}</h4>
                       </div>
                   </div>
                   <div className="flex items-center gap-2">
                       <button 
                           onClick={() => handleToggleElectiveStatus(item)} 
                           className={`p-2.5 rounded-xl transition-all ${item.status === 'planned' ? 'text-indigo-600 bg-indigo-50' : 'text-amber-500 bg-amber-50'}`}
                       >
                           {item.status === 'planned' ? <CheckCircle2 className="w-5 h-5"/> : <Undo2 className="w-5 h-5"/>}
                       </button>
                       <button onClick={() => handleDeleteElective(item.id)} className="p-2.5 text-slate-300 hover:text-red-500 hover:bg-red-50 rounded-xl transition-colors"><Trash2 className="w-5 h-5" /></button>
                   </div>
                 </div>
               ))}
            </div>
          </div>
        )}

        {/* 3. ç»Ÿè®¡ä»ªè¡¨ç›˜ */}
        {activeTab === 'stats' && (
          <div className="animate-in fade-in zoom-in-95 duration-300 space-y-8 md:space-y-10 pb-20">
            {/* æ€»è¿›åº¦å¡ç‰‡ */}
            <div className="bg-gradient-to-br from-indigo-600 to-purple-700 rounded-[2rem] p-6 md:p-8 text-white shadow-xl shadow-indigo-200 flex flex-col md:flex-row items-center justify-between relative overflow-hidden">
              <div className="absolute -top-10 -right-10 w-64 h-64 bg-white opacity-10 rounded-full blur-3xl"></div>
              <div className="absolute bottom-0 left-0 w-full h-1/2 bg-gradient-to-t from-black/10 to-transparent"></div>
              
              <div className="flex items-center space-x-6 relative z-10 w-full md:w-auto mb-6 md:mb-0">
                <div className="p-4 bg-white/10 backdrop-blur-md rounded-2xl hidden md:block border border-white/10"><Target className="w-10 h-10 text-white" /></div>
                <div className="text-center md:text-left w-full md:w-auto">
                  <p className="text-indigo-100 text-sm font-medium mb-1 opacity-80">æ¯•ä¸šæ€»å­¦åˆ†è¿›åº¦</p>
                  <div className="flex items-baseline justify-center md:justify-start space-x-2">
                    <h2 className="text-6xl font-black tracking-tighter">{stats.totalEarned}</h2>
                    <span className="text-indigo-200 font-bold text-xl">/ {stats.totalRequired}</span>
                  </div>
                  <div className="mt-2 text-sm bg-white/20 inline-block px-3 py-1 rounded-lg backdrop-blur-md">GPA: <span className="font-bold text-white">{stats.gpa}</span></div>
                </div>
              </div>
              <div className="relative z-10 w-full md:w-auto">
                <div className="flex items-center justify-between md:justify-end gap-3 bg-white/10 px-5 py-4 rounded-xl border border-white/10 backdrop-blur-md">
                    <span className="text-xs font-bold text-amber-300 flex items-center"><Clock className="w-4 h-4 mr-2"/> è®¡åˆ’ä¸­</span>
                    <span className="text-2xl font-bold">+{stats.totalPlanned}</span>
                </div>
              </div>
            </div>

            {/* é€šè¯†æ ¸å¿ƒ */}
            <section>
              <div className="flex items-center space-x-2 mb-4 px-1">
                <LayoutDashboard className="w-5 h-5 text-indigo-600" />
                <h3 className="font-bold text-slate-800">é€šè¯†æ ¸å¿ƒ (2åˆ†/é¡¹)</h3>
              </div>
              <div className="grid grid-cols-2 lg:grid-cols-4 gap-3 md:gap-4">
                {Object.keys(GE_CORE_MODULES).map(cat => {
                  const data = stats.breakdown[cat];
                  const isDone = data.earned >= data.required;
                  const config = GE_CORE_MODULES[cat];
                  return (
                    <div key={cat} className={`p-4 rounded-2xl border transition-all ${isDone ? 'bg-white border-green-200 shadow-sm' : 'bg-white border-slate-100'}`}>
                      <div className="flex justify-between items-start mb-3">
                        <div className={`w-8 h-8 rounded-lg flex items-center justify-center text-white shadow-sm ${config.color} ${config.shadow}`}>
                          {isDone ? <CheckCircle2 className="w-5 h-5" /> : <Star className="w-4 h-4" />}
                        </div>
                        <span className={`font-mono font-bold text-sm ${isDone ? 'text-green-600' : 'text-slate-400'}`}>{data.earned}/{data.required}</span>
                      </div>
                      <h4 className="font-bold text-slate-700 text-sm mb-1">{cat.replace('é€šæ ¸-', '')}</h4>
                      <p className="text-[10px] text-slate-400 leading-tight">
                        {isDone ? 'å·²å®Œæˆ' : `ç¼º ${data.required - data.earned} åˆ†`}
                      </p>
                    </div>
                  );
                })}
              </div>
            </section>

            {/* æ‹“å±•ä¸åˆ›æ–° */}
            <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
              <div className="bg-white p-6 rounded-[2rem] border border-slate-100 shadow-sm">
                <div className="flex items-center space-x-2 mb-5"><Award className="w-5 h-5 text-amber-500"/><h3 className="font-bold text-slate-800">æ‹“å±•åŸ¹å…»</h3></div>
                <div className="space-y-5">
                  {Object.keys(EXTENSION_MODULES).map(cat => {
                    const data = stats.breakdown[cat];
                    const progress = Math.min((data.earned / data.required) * 100, 100);
                    return (
                      <div key={cat}>
                        <div className="flex justify-between text-xs font-bold mb-2">
                          <span className="text-slate-600">{cat.replace('æ‹“å±•-', '')}</span>
                          <span className={data.earned >= data.required ? 'text-green-500' : 'text-slate-400'}>{data.earned}/{data.required}</span>
                        </div>
                        <div className="h-2 bg-slate-50 rounded-full overflow-hidden">
                          <div className={`h-full transition-all duration-1000 ease-out ${EXTENSION_MODULES[cat].color}`} style={{ width: `${progress}%` }} />
                        </div>
                      </div>
                    );
                  })}
                </div>
              </div>

              <div className="bg-white p-6 rounded-[2rem] border border-slate-100 shadow-sm">
                <div className="flex items-center space-x-2 mb-5"><Boxes className="w-5 h-5 text-cyan-500"/><h3 className="font-bold text-slate-800">åˆ›æ–°åˆ›ä¸š</h3></div>
                <div className="space-y-5">
                  {Object.keys(INNOVATION_MODULES).map(cat => {
                    const data = stats.breakdown[cat];
                    const progress = Math.min((data.earned / data.required) * 100, 100);
                    return (
                      <div key={cat}>
                        <div className="flex justify-between text-xs font-bold mb-2">
                          <span className="text-slate-600">{cat}</span>
                          <span className={data.earned >= data.required ? 'text-green-500' : 'text-slate-400'}>{data.earned}/{data.required}</span>
                        </div>
                        <div className="h-2 bg-slate-50 rounded-full overflow-hidden">
                          <div className={`h-full transition-all duration-1000 ease-out ${INNOVATION_MODULES[cat].color}`} style={{ width: `${progress}%` }} />
                        </div>
                      </div>
                    );
                  })}
                </div>
              </div>
            </div>
            
            {/* åŸºç¡€æ±‡æ€» */}
            <div className="grid grid-cols-2 md:grid-cols-3 gap-3 md:gap-4">
               {Object.keys(BASE_REQUIREMENTS).map(cat => {
                 const data = stats.breakdown[cat];
                 return (
                   <div key={cat} className="bg-white p-4 rounded-xl border border-slate-100 shadow-sm flex items-center justify-between">
                     <div>
                       <p className="text-[10px] font-bold text-slate-400 uppercase mb-0.5">{cat}</p>
                       <span className="text-lg font-black text-slate-700">{data.earned}</span>
                     </div>
                     <div className={`w-1.5 h-8 rounded-full ${BASE_REQUIREMENTS[cat].color} opacity-80`}></div>
                   </div>
                 );
               })}
            </div>
          </div>
        )}
      </main>

      {/* å­¦æœŸè¯¦æƒ…å¼¹çª— (Mobile: Bottom Sheet, Desktop: Right Drawer) */}
      {selectedSemester && (
        <div className="fixed inset-0 z-50 flex items-end md:items-stretch md:justify-end">
          {/* Backdrop */}
          <div className="absolute inset-0 bg-slate-900/30 backdrop-blur-sm transition-opacity animate-in fade-in duration-300" onClick={() => setSelectedSemester(null)}></div>
          
          {/* Content */}
          <div className="relative bg-[#f8fafc] w-full md:max-w-md h-[85vh] md:h-full shadow-2xl rounded-t-[2rem] md:rounded-l-[2rem] md:rounded-tr-none flex flex-col modal-enter overflow-hidden">
            {/* Mobile Drag Handle */}
            <div className="md:hidden w-full flex justify-center pt-3 pb-1" onClick={() => setSelectedSemester(null)}>
                <div className="w-12 h-1.5 bg-slate-300 rounded-full"></div>
            </div>

            <div className="px-6 md:px-8 py-4 flex justify-between items-center bg-white border-b border-slate-100 z-10">
              <div>
                <h2 className="text-2xl font-black text-slate-800">ç¬¬ {selectedSemester} å­¦æœŸ</h2>
                <p className="text-slate-400 text-xs font-medium mt-0.5">å¿…ä¿®è¯¾ç¨‹æ¸…å•</p>
              </div>
              <button onClick={() => setSelectedSemester(null)} className="p-2 bg-slate-100 rounded-full hover:bg-slate-200 transition-all tap-active"><X className="w-5 h-5 text-slate-600" /></button>
            </div>
            
            <div className="flex-1 overflow-y-auto p-4 md:p-6 space-y-3 overscroll-contain">
              {CURRICULUM_DATA[selectedSemester].map((course, idx) => {
                if (course.isPlaceholder) return null;
                const record = planProgress[course.name] || {};
                const status = record.status || 'untaken';
                
                return (
                  <div key={idx} className={`border rounded-2xl p-4 transition-all duration-300 ${status === 'completed' ? 'bg-green-50/50 border-green-200' : status === 'planned' ? 'bg-amber-50/50 border-amber-200' : 'bg-white border-slate-100'}`}>
                    <div className="flex items-start gap-4">
                      <button onClick={() => handleToggleFixedCourse(course.name)} className={`mt-1 w-6 h-6 rounded-full flex items-center justify-center border-2 transition-all flex-shrink-0 tap-active ${status === 'completed' ? 'bg-green-500 border-green-500 text-white' : status === 'planned' ? 'bg-amber-400 border-amber-400 text-white' : 'bg-white border-slate-200'}`}>
                        {status === 'completed' ? <CheckCircle2 className="w-4 h-4" /> : status === 'planned' ? <Clock className="w-4 h-4" /> : null}
                      </button>
                      <div className="flex-1">
                        <div className="flex justify-between items-start">
                          <h4 className={`font-bold leading-snug text-sm transition-all ${status === 'completed' ? 'text-green-800 line-through opacity-50' : 'text-slate-700'}`}>{course.name}</h4>
                          <span className={`text-[10px] text-white px-1.5 py-0.5 rounded font-bold shadow-sm ${ALL_STATS_CONFIG[course.category]?.color}`}>{course.category.slice(0,2)}</span>
                        </div>
                        <div className="flex items-center mt-1 space-x-3">
                           <span className="text-[10px] text-slate-400 font-medium">{course.credits} å­¦åˆ†</span>
                        </div>
                        
                        {(status === 'planned' || status === 'completed') && (
                          <div className="mt-3 animate-in slide-in-from-top-2 fade-in duration-300">
                             <input type="number" placeholder="è¾“å…¥åˆ†æ•° (å¯é€‰)" value={record.score || ''} onChange={(e) => handleUpdateFixedScore(course.name, e.target.value)} className="w-full bg-white border border-slate-200 rounded-xl px-3 py-2 text-sm focus:ring-2 focus:ring-indigo-500 outline-none transition-all" />
                          </div>
                        )}
                      </div>
                    </div>
                  </div>
                );
              })}
              <div className="h-10"></div>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}